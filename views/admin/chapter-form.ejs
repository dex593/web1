<!DOCTYPE html>
<html lang="vi">
  <%- include("../partials/head", { title }) %>
  <body>
    <% const isTeamMode = Boolean(teamManageScope && teamManageScope.teamId); %>
    <% const initialGroupTeams = Array.isArray(groupTeamSelections) ? groupTeamSelections : []; %>
    <% const initialGroupName = (chapter.groupName || chapterGroupName || initialGroupTeams.map((item) => item.name).join(' / ') || '').toString(); %>
    <% const initialGroupIds = initialGroupTeams.map((item) => Number(item.id)).filter((id) => Number.isFinite(id) && id > 0).join(','); %>
    <div class="site admin">
      <%- include("partials/nav") %>
      <main>
        <section class="section container">
          <div class="admin-section-header">
            <div>
              <% const chapterLabel = chapter.isOneshot ? "Oneshot" : `Chương ${chapter.number}`; %>
              <h1>Chỉnh sửa chương</h1>
              <p class="note">
                <strong><%= chapter.mangaTitle %></strong> — <%= chapterLabel %>
              </p>
            </div>
            <div class="admin-actions">
              <a
                class="button button--ghost"
                href="/manga/<%= chapter.mangaSlug %>/chapters/<%= chapter.number %>"
                target="_blank"
                rel="noopener"
              >
                Xem chương
              </a>
              <a
                class="button button--ghost"
                href="/admin/manga/<%= chapter.mangaId %>/chapters"
                data-confirm-href="/admin/manga/<%= chapter.mangaId %>/chapters"
                data-confirm-title="Rời trang?"
                data-confirm-body="Các thay đổi chưa lưu sẽ bị mất."
                data-confirm-confirm-text="Rời trang"
              >
                Quay lại
              </a>
            </div>
          </div>

          <div class="panel admin-form">
            <div class="admin-section-header">
              <h2>Thông tin chương</h2>
            </div>

            <% if (!b2Ready) { %>
              <p class="admin-error">
                Thiếu cấu hình lưu trữ ảnh trong <code>.env</code>. Vui lòng cấu hình dịch vụ lưu trữ ảnh để upload trang.
              </p>
            <% } else if (!draftToken) { %>
              <p class="admin-error">Không tạo được phiên upload tạm. Vui lòng tải lại trang.</p>
            <% } %>

            <form
              class="admin-grid"
              method="post"
              action="<%= formAction %>"
              data-chapter-new-form
              data-b2-ready="<%= b2Ready && draftToken ? "1" : "0" %>"
              data-draft-token="<%= draftToken %>"
              data-draft-ttl-minutes="<%= draftTtlMinutes %>"
              data-chapter-numbers="<%= JSON.stringify(chapterNumbers || []) %>"
              data-allow-replace="1"
            >
              <input type="hidden" name="draft_token" value="<%= draftToken %>" data-draft-token-input />
              <input type="hidden" name="draft_pages" value="<%= JSON.stringify(existingPageIds || []) %>" data-draft-pages-input />
              <input type="hidden" name="existing_pages" value="<%= JSON.stringify(existingPages || []) %>" />
              <input type="hidden" name="pages_touched" value="0" data-pages-touched-input />

              <% if (chapter.isOneshot) { %>
                <input type="hidden" name="number" value="0" data-chapter-number-input />
                <div class="admin-field admin-field--wide">
                  <span>Loại chương</span>
                  <input type="text" value="Oneshot" readonly />
                  <span class="admin-sub">Truyện đang bật Oneshot nên chương này luôn cố định số 0.</span>
                </div>
              <% } else { %>
                <label class="admin-field">
                  <span>Số chương</span>
                  <input
                    type="text"
                    name="number"
                    inputmode="decimal"
                    pattern="[0-9]+([.,][0-9]+)?"
                    value="<%= chapter.number %>"
                    required
                    autocomplete="off"
                    spellcheck="false"
                    data-chapter-number-input
                  />
                </label>
                <p class="admin-error" data-chapter-number-error hidden></p>

                <label class="admin-field admin-field--wide">
                  <span>Vị trí trong danh sách</span>
                  <select name="position" data-chapter-position-select>
                    <option value="after_latest" selected>Sau chương mới nhất (mặc định)</option>
                    <% (chapterNumbers || []).forEach((value) => { %>
                      <option value="after:<%= value %>">Sau chương <%= value %></option>
                    <% }) %>
                  </select>
                  <span class="admin-sub">
                    Chọn vị trí để hệ thống gợi ý số chương. Bạn vẫn có thể sửa lại số chương thủ công.
                  </span>
                </label>
              <% } %>

              <label class="admin-field admin-field--wide">
                <span>Tiêu đề (tuỳ chọn)</span>
                <input type="text" name="title" value="<%= chapter.title %>" autocomplete="off" />
              </label>

              <label
                class="admin-field admin-field--wide admin-team-selector"
                data-team-group-picker
                data-team-search-endpoint="/admin/teams/search"
              >
                <span>Nhóm dịch</span>
                <input type="hidden" name="group_name" value="<%= initialGroupName %>" data-team-group-value />
                <input type="hidden" name="group_team_ids" value="<%= initialGroupIds %>" data-team-group-ids />
                <input
                  type="hidden"
                  value="<%= JSON.stringify(initialGroupTeams.map((item) => ({ id: item.id, name: item.name, slug: item.slug }))) %>"
                  data-team-initial-teams
                />

                <% if (isTeamMode) { %>
                  <input type="text" value="<%= teamManageScope.teamName || initialGroupName %>" readonly />
                <% } else { %>
                  <div class="admin-team-selector__selected" data-team-selected-list></div>
                  <input
                    type="search"
                    placeholder="Tìm nhóm dịch theo tên hoặc slug"
                    autocomplete="off"
                    data-team-search-input
                  />
                  <div class="admin-team-selector__results" hidden data-team-search-results></div>
                  <p class="admin-error" hidden data-team-search-error></p>
                  <span class="admin-sub">Chọn một hoặc nhiều nhóm dịch từ danh sách tìm kiếm.</span>
                <% } %>

                <% if (isTeamMode) { %>
                  <span class="admin-sub">Ở chế độ nhóm, bạn chỉ được chỉnh sửa chapter của nhóm mình.</span>
                <% } %>
              </label>

              <div class="admin-field admin-field--wide">
                <span>Trang</span>
                <p class="note">
                  Kéo thả để thêm trang. Có thể kéo để đổi thứ tự. Bấm vào ảnh để thay trang. Nút <i class="fa-solid fa-xmark" aria-hidden="true"></i> để xóa.
                  Ảnh sẽ tự upload tạm lên khu vực <code>tmp</code> của hệ thống lưu trữ ảnh. Nếu không lưu, hệ thống sẽ tự xóa sau
                  <strong><%= draftTtlLabel %></strong>.
                </p>

                <label class="upload-drop <%= b2Ready && draftToken ? "" : "is-disabled" %>" data-upload-drop>
                  <input
                    class="upload-input"
                    type="file"
                    accept="image/jpeg,image/png,image/webp"
                    multiple
                    data-chapter-draft-pages-input
                    <%= b2Ready && draftToken ? "" : "disabled" %>
                  />
                  <span class="upload-drop__title">Kéo thả ảnh vào đây</span>
                  <span class="upload-drop__sub">hoặc bấm để chọn (JPG/PNG/WebP)</span>
                </label>

                <div class="upload-overall upload-overall--inline" hidden data-upload-overall>
                  <div class="upload-progress">
                    <div class="upload-progress__bar" style="width: 0%" data-upload-overall-bar></div>
                  </div>
                  <p class="note" data-upload-overall-text></p>
                </div>

                <div class="admin-error" hidden data-draft-upload-error></div>
                <div class="upload-queue upload-queue--draft" hidden data-upload-queue></div>

                <script
                  type="application/json"
                  data-chapter-initial-pages
                  nonce="<%= cspNonce || "" %>"
                >
                  <%- JSON.stringify(initialPages || []) %>
                </script>
              </div>

              <div class="admin-actions">
                <button class="button" type="submit" data-chapter-save disabled>Lưu thay đổi</button>
                <a
                  class="button button--ghost"
                  href="/admin/manga/<%= chapter.mangaId %>/chapters"
                  data-confirm-href="/admin/manga/<%= chapter.mangaId %>/chapters"
                  data-confirm-title="Hủy thay đổi?"
                  data-confirm-body="Các thay đổi chưa lưu sẽ bị mất."
                  data-confirm-confirm-text="Bỏ thay đổi"
                >
                  Hủy
                </a>
              </div>
            </form>
          </div>
        </section>

        <dialog class="modal" data-confirm-dialog aria-label="Xác nhận thao tác">
          <div class="modal-card" role="document">
            <div class="modal-head">
              <h3 class="modal-title" data-dialog-title></h3>
              <button class="modal-close" type="button" data-dialog-close aria-label="Đóng">
                <i class="fa-solid fa-xmark" aria-hidden="true"></i>
              </button>
            </div>
            <p class="modal-body" data-dialog-body></p>
            <div class="modal-meta" data-dialog-meta></div>
            <div class="modal-actions">
              <button class="button button--ghost" type="button" data-dialog-cancel>Hủy</button>
              <button class="button" type="button" data-dialog-confirm>Xác nhận</button>
            </div>
          </div>
        </dialog>
      </main>
    </div>
  </body>
</html>
