<%
  const isTeamMode = Boolean(teamManageScope && teamManageScope.teamId);
  const teamModeRole = isTeamMode ? (teamManageScope.role || "").toString().trim().toLowerCase() : "";
  const teamModePermissions = isTeamMode && teamManagePermissions && typeof teamManagePermissions === "object"
    ? teamManagePermissions
    : null;
  const canAddManga = !isTeamMode || !teamModePermissions || Boolean(teamModePermissions.canAddManga);
  const canEditManga = !isTeamMode || !teamModePermissions || Boolean(teamModePermissions.canEditManga);
  const canDeleteManga = !isTeamMode || !teamModePermissions || Boolean(teamModePermissions.canDeleteManga);
  const canAddChapter = !isTeamMode || !teamModePermissions || Boolean(teamModePermissions.canAddChapter);
  const canEditChapter = !isTeamMode || !teamModePermissions || Boolean(teamModePermissions.canEditChapter);
  const canDeleteChapter = !isTeamMode || !teamModePermissions || Boolean(teamModePermissions.canDeleteChapter);
  const canManageAnyChapter = canAddChapter || canEditChapter || canDeleteChapter;
  const showMangaActionColumn = !isTeamMode || !teamModePermissions || canEditManga || canDeleteManga;
  const mangaTableColumnCount = showMangaActionColumn ? 5 : 4;
  const teamModeTeamId = isTeamMode ? Number(teamManageScope.teamId) || 0 : 0;
  const teamModeTeamSlug = isTeamMode ? (teamManageScope.teamSlug || "").toString().trim() : "";
  const teamModeTeamName = isTeamMode ? (teamManageScope.teamName || "").toString().trim() : "";
  const pageState = pagination && typeof pagination === "object"
    ? pagination
    : { page: 1, totalPages: 1, hasPrev: false, hasNext: false, prevPage: 1, nextPage: 1, perPage: 30 };
  const buildAdminMangaPageHref = (targetPage) => {
    const safeTarget = Number.isFinite(targetPage) && targetPage > 0 ? Math.floor(targetPage) : 1;
    const params = new URLSearchParams();
    if (filters.q) {
      params.set("q", filters.q);
    }
    (filters.include || []).forEach((genreId) => {
      params.append("include", String(genreId));
    });
    (filters.exclude || []).forEach((genreId) => {
      params.append("exclude", String(genreId));
    });
    if (pageState.perPage && Number(pageState.perPage) !== 30) {
      params.set("perPage", String(pageState.perPage));
    }
    if (safeTarget > 1) {
      params.set("page", String(safeTarget));
    }
    if (isTeamMode && teamModeTeamId > 0) {
      params.set("teamId", String(teamModeTeamId));
      params.set("teamMode", "1");
    }
    const query = params.toString();
    return query ? `/admin/manga?${query}` : "/admin/manga";
  };
%>
<!DOCTYPE html>
<html lang="vi">
  <%- include("../partials/head", { title }) %>
  <body>
    <div class="site admin">
      <%- include("partials/nav") %>
      <main>
        <section class="section container">
          <div class="admin-section-header">
            <div>
              <h1><%= isTeamMode ? `Quản lý truyện - ${teamModeTeamName || 'Nhóm dịch'}` : "Quản lý truyện" %></h1>
              <p class="note"><%= isTeamMode
                ? (teamModeRole === "leader"
                  ? "Bạn đang ở chế độ leader: chỉ hiển thị truyện thuộc nhóm của bạn."
                  : "Bạn đang ở chế độ member của nhóm: chỉ thao tác trong phạm vi quyền đã được cấp.")
                : "Thêm, chỉnh sửa và quản lý chương truyện." %></p>
            </div>
            <div class="admin-actions">
              <% if (canAddManga) { %>
                <a class="button" href="/admin/manga/new">Thêm truyện</a>
              <% } %>
              <% if (isTeamMode && teamModeTeamId > 0 && teamModeTeamSlug) { %>
                <a class="button button--ghost" href="/team/<%= encodeURIComponent(String(teamModeTeamId)) %>/<%= encodeURIComponent(teamModeTeamSlug) %>">
                  Về trang nhóm
                </a>
              <% } %>
            </div>
          </div>
          <div class="panel">
            <div class="filter-panel admin-filter-panel">
              <div class="filter-head">
                <p class="filter-title">Tìm kiếm</p>
                <p class="filter-sub">
                  Gõ để lọc ngay. Nhấn 1 lần để chọn, 2 lần để loại trừ, 3 lần để bỏ.
                </p>
              </div>
              <form
                class="filter-form filter-form--advanced"
                action="/admin/manga"
                method="get"
                data-manga-filter-form
                data-can-edit-manga="<%= canEditManga ? '1' : '0' %>"
                data-can-delete-manga="<%= canDeleteManga ? '1' : '0' %>"
                data-can-manage-any-chapter="<%= canManageAnyChapter ? '1' : '0' %>"
                data-show-manga-actions="<%= showMangaActionColumn ? '1' : '0' %>"
                data-manga-column-count="<%= mangaTableColumnCount %>"
              >
                <label class="filter-field filter-field--wide">
                  <span>Từ khóa</span>
                  <div class="input-clear-wrap">
                    <input
                      type="search"
                      name="q"
                      value="<%= filters.q %>"
                      placeholder="Tên truyện, tác giả, ID (#12)..."
                      autocomplete="off"
                      aria-label="Tìm kiếm"
                      data-manga-filter-input
                    />
                    <button
                      class="input-clear"
                      type="button"
                      aria-label="Xóa tìm kiếm"
                      data-manga-filter-clear
                      <% if (!filters.q) { %>hidden<% } %>
                    >
                      <i class="fa-solid fa-xmark" aria-hidden="true"></i>
                    </button>
                  </div>
                </label>

                <div class="filter-group">
                  <p class="filter-group-title">Thể loại</p>
                  <% if (genres.length) { %>
                    <div class="filter-options" data-filter-options>
                      <% genres.forEach((genre) => { %>
                        <% const state = filters.include.includes(genre.id)
                          ? "include"
                          : filters.exclude.includes(genre.id)
                          ? "exclude"
                          : "none"; %>
                        <button
                          type="button"
                          class="filter-option filter-option--toggle <%= state === "include" ? "is-include" : state === "exclude" ? "is-exclude" : "" %>"
                          data-genre="<%= genre.id %>"
                          data-state="<%= state %>"
                        >
                          <span class="filter-state"></span>
                          <span class="filter-name"><%= genre.name %></span>
                        </button>
                      <% }) %>
                    </div>
                  <% } else { %>
                    <p class="note">Chưa có thể loại để lọc.</p>
                  <% } %>
                </div>

                <div class="filter-hidden" data-filter-hidden>
                  <% (filters.include || []).forEach((genreId) => { %>
                    <input type="hidden" name="include" value="<%= genreId %>" />
                  <% }) %>
                  <% (filters.exclude || []).forEach((genreId) => { %>
                    <input type="hidden" name="exclude" value="<%= genreId %>" />
                  <% }) %>
                </div>
              </form>
              <p class="filter-summary">
                Hiển thị <span data-manga-result-count><%= resultCount %></span> truyện.
              </p>
            </div>
            <div class="admin-table-wrap">
              <table class="admin-table admin-table--stack admin-table--manga">
                <colgroup>
                  <col />
                <col style="width: 140px;" />
                <col style="width: 110px;" />
                <col style="width: 120px;" />
                <% if (showMangaActionColumn) { %>
                  <col style="width: 200px;" data-manga-col-actions />
                <% } %>
              </colgroup>
              <thead>
                <tr>
                  <th>Truyện</th>
                  <th>Trạng thái</th>
                  <th>Số chương</th>
                  <th>Cập nhật</th>
                  <% if (showMangaActionColumn) { %>
                    <th data-manga-th-actions>Hành động</th>
                  <% } %>
                </tr>
              </thead>
              <tbody data-manga-table-body>
                <% if (mangaLibrary.length === 0) { %>
                  <tr>
                    <td colspan="<%= mangaTableColumnCount %>">
                      <%= filters.q || filters.include.length || filters.exclude.length
                          ? "Không có truyện phù hợp."
                          : "Chưa có truyện." %>
                    </td>
                  </tr>
                  <% } else { %>
                    <% mangaLibrary.forEach((manga) => { %>
                      <tr>
                        <td data-label="Truyện">
                          <% if (canEditManga) { %>
                            <a class="admin-manga-link" href="/admin/manga/<%= manga.id %>/edit">
                              <strong><%= manga.title %></strong>
                            </a>
                          <% } else { %>
                            <strong><%= manga.title %></strong>
                          <% } %>
                          <span class="admin-sub"><%= manga.groupName || manga.author %></span>
                          <% if (manga.isHidden) { %>
                            <span class="chip chip--warn">Đang ẩn</span>
                          <% } %>
                        </td>
                        <td data-label="Trạng thái"><span class="tag"><%= manga.status %></span></td>
                        <td data-label="Số chương">
                          <% if (canManageAnyChapter) { %>
                            <a
                              class="chip chip--link"
                              href="/admin/manga/<%= manga.id %>/chapters"
                              title="Quản lý chương"
                              aria-label="Quản lý chương của truyện <%= manga.title %>"
                            >
                              <%= manga.chapterCount || 0 %>
                            </a>
                          <% } else { %>
                            <span class="chip"><%= manga.chapterCount || 0 %></span>
                          <% } %>
                        </td>
                        <td data-label="Cập nhật"><%= formatDate(manga.updatedAt) %></td>
                        <% if (showMangaActionColumn) { %>
                          <td class="admin-cell-actions" data-label="Hành động">
                            <div class="admin-actions">
                              <% if (canEditManga) { %>
                                <form
                                  method="post"
                                  action="/admin/manga/<%= manga.id %>/visibility"
                                  data-confirm-action="<%= manga.isHidden ? "show-manga" : "hide-manga" %>"
                                  data-manga-id="<%= manga.id %>"
                                  data-manga-title="<%= manga.title %>"
                                  data-manga-chapters="<%= manga.chapterCount || 0 %>"
                                  data-manga-hidden="<%= manga.isHidden ? 1 : 0 %>"
                                >
                                  <input type="hidden" name="hidden" value="<%= manga.isHidden ? 0 : 1 %>" />
                                  <button class="button button--ghost" type="submit">
                                    <%= manga.isHidden ? "Hiện" : "Ẩn" %>
                                  </button>
                                </form>
                              <% } %>
                              <% if (canDeleteManga) { %>
                                <form
                                  method="post"
                                  action="/admin/manga/<%= manga.id %>/delete"
                                  data-confirm-action="delete-manga"
                                  data-manga-id="<%= manga.id %>"
                                  data-manga-title="<%= manga.title %>"
                                  data-manga-chapters="<%= manga.chapterCount || 0 %>"
                                  data-manga-hidden="<%= manga.isHidden ? 1 : 0 %>"
                                >
                                  <button class="button button--ghost button--danger" type="submit">Xóa</button>
                                </form>
                              <% } %>
                              <% if (!canEditManga && !canDeleteManga) { %>
                                <span class="note">Không có quyền thao tác</span>
                              <% } %>
                            </div>
                          </td>
                        <% } %>
                      </tr>
                    <% }) %>
                  <% } %>
                </tbody>
              </table>
            </div>
            <% if (pageState.totalPages > 1) { %>
              <nav class="comment-pagination" aria-label="Phân trang quản lý truyện">
                <a
                  class="button button--ghost comment-pagination__nav <%= pageState.hasPrev ? "" : "is-disabled" %>"
                  href="<%= pageState.hasPrev ? buildAdminMangaPageHref(pageState.prevPage) : "#" %>"
                  aria-label="Trang trước"
                  <%= pageState.hasPrev ? "" : 'tabindex="-1" aria-disabled="true"' %>
                >
                  <i class="fa-solid fa-chevron-left" aria-hidden="true"></i>
                  <span class="sr-only">Trang trước</span>
                </a>
                <span class="chip comment-pagination__meta">Trang <%= pageState.page %>/<%= pageState.totalPages %></span>
                <a
                  class="button button--ghost comment-pagination__nav <%= pageState.hasNext ? "" : "is-disabled" %>"
                  href="<%= pageState.hasNext ? buildAdminMangaPageHref(pageState.nextPage) : "#" %>"
                  aria-label="Trang sau"
                  <%= pageState.hasNext ? "" : 'tabindex="-1" aria-disabled="true"' %>
                >
                  <i class="fa-solid fa-chevron-right" aria-hidden="true"></i>
                  <span class="sr-only">Trang sau</span>
                </a>
              </nav>
            <% } %>
          </div>
        </section>

        <dialog class="modal" data-confirm-dialog aria-label="Xác nhận thao tác">
          <div class="modal-card" role="document">
            <div class="modal-head">
              <h3 class="modal-title" data-dialog-title></h3>
              <button class="modal-close" type="button" data-dialog-close aria-label="Đóng">
                <i class="fa-solid fa-xmark" aria-hidden="true"></i>
              </button>
            </div>
            <p class="modal-body" data-dialog-body></p>
            <div class="modal-meta" data-dialog-meta></div>
            <div class="modal-actions">
              <button class="button button--ghost" type="button" data-dialog-cancel>Hủy</button>
              <button class="button" type="button" data-dialog-confirm>Xác nhận</button>
            </div>
          </div>
        </dialog>
      </main>
    </div>
  </body>
</html>
