<%
  const truncateCardTitle = (value) => {
    const text = (value || "").toString().replace(/\s+/g, " ").trim();
    if (!text) return "";

    const maxWords = 4;
    const maxChars = 24;
    const words = text.split(" ").filter(Boolean);
    let shortened = words.length > maxWords ? words.slice(0, maxWords).join(" ") : text;
    if (shortened.length > maxChars) {
      shortened = shortened.slice(0, maxChars).trimEnd();
    }

    return shortened.length < text.length ? `${shortened}...` : shortened;
  };

  const pageState = pagination && typeof pagination === "object"
    ? pagination
    : { page: 1, totalPages: 1, hasPrev: false, hasNext: false, prevPage: 1, nextPage: 1, perPage: 24 };
  const buildCatalogPageHref = (targetPage) => {
    const safeTarget = Number.isFinite(targetPage) && targetPage > 0 ? Math.floor(targetPage) : 1;
    const params = new URLSearchParams();
    if (filters.q) {
      params.set("q", filters.q);
    }
    (filters.include || []).forEach((genreId) => {
      params.append("include", String(genreId));
    });
    (filters.exclude || []).forEach((genreId) => {
      params.append("exclude", String(genreId));
    });
    if (pageState.perPage && Number(pageState.perPage) !== 24) {
      params.set("perPage", String(pageState.perPage));
    }
    if (safeTarget > 1) {
      params.set("page", String(safeTarget));
    }
    const query = params.toString();
    return query ? `/manga?${query}` : "/manga";
  };

  const appendCoverVariant = (url, width, height, quality) => {
    const raw = (url || "").toString().trim();
    const parsedWidth = Number(width);
    const parsedHeight = Number(height);
    const parsedQuality = Number(quality);
    if (!raw || !Number.isFinite(parsedWidth) || parsedWidth <= 0) return raw;

    const params = [`w=${Math.floor(parsedWidth)}`];
    if (Number.isFinite(parsedHeight) && parsedHeight > 0) {
      params.push(`h=${Math.floor(parsedHeight)}`);
    }
    if (Number.isFinite(parsedQuality) && parsedQuality > 0) {
      params.push(`q=${Math.floor(parsedQuality)}`);
    }

    const separator = raw.includes("?") ? "&" : "?";
    return `${raw}${separator}${params.join("&")}`;
  };

  const mangaHeadStyles = {
    fontAwesome: false
  };
%>
<!DOCTYPE html>
<html lang="vi">
  <%- include("partials/head", {
    title,
    headStyles: mangaHeadStyles
  }) %>
  <body>
    <div class="site">
      <%- include("partials/header") %>
      <main>
        <section class="section container">
          <div class="section-header">
            <h1>Toàn bộ truyện</h1>
            <span class="section-line"></span>
          </div>
          <p class="lede">Toàn bộ series do BFANG Team lưu trữ và quản lý.</p>
          <div class="filter-panel panel">
            <div class="filter-head">
              <p class="filter-title">Tìm kiếm nâng cao</p>
              <p class="filter-sub">Nhấn 1 lần để chọn, 2 lần để loại trừ, 3 lần để bỏ.</p>
            </div>
            <form class="filter-form filter-form--advanced" action="/manga" method="get">
              <label class="filter-field filter-field--wide">
                <span>Tìm kiếm</span>
                <input
                  type="search"
                  name="q"
                  placeholder="Tên truyện, tác giả"
                  value="<%= filters.q %>"
                />
              </label>
              <div class="filter-group">
                <p class="filter-group-title">Thể loại</p>
                <% if (genres.length) { %>
                  <div class="filter-options" data-filter-options>
                    <% genres.forEach((genre) => { %>
                      <% const state = filters.include.includes(genre.id)
                        ? "include"
                        : filters.exclude.includes(genre.id)
                        ? "exclude"
                        : "none"; %>
                      <button
                        type="button"
                        class="filter-option filter-option--toggle <%= state === "include" ? "is-include" : state === "exclude" ? "is-exclude" : "" %>"
                        data-genre="<%= genre.id %>"
                        data-state="<%= state %>"
                      >
                        <span class="filter-state"></span>
                        <span class="filter-name"><%= genre.name %></span>
                      </button>
                    <% }) %>
                  </div>
                <% } else { %>
                  <p class="note">Chưa có thể loại để chọn.</p>
                <% } %>
              </div>
              <div class="filter-hidden" data-filter-hidden>
                <% filters.include.forEach((genreId) => { %>
                  <input type="hidden" name="include" value="<%= genreId %>" />
                <% }) %>
                <% filters.exclude.forEach((genreId) => { %>
                  <input type="hidden" name="exclude" value="<%= genreId %>" />
                <% }) %>
              </div>
              <div class="filter-actions">
                <button class="button" type="submit">Tìm kiếm</button>
                <% if (filters.q || filters.include.length || filters.exclude.length) { %>
                  <a class="button button--ghost" href="/manga">Xóa lọc</a>
                <% } %>
              </div>
            </form>
            <p class="filter-summary">Hiển thị <%= resultCount %> truyện.</p>
          </div>
          <% if (mangaLibrary.length === 0) { %>
            <p class="note">Không có truyện phù hợp với bộ lọc hiện tại.</p>
          <% } else { %>
            <div class="manga-grid manga-grid--catalog">
              <% mangaLibrary.forEach((manga, index) => { %>
                <article class="manga-card">
                  <a href="/manga/<%= manga.slug %>">
                    <div class="cover">
                      <% if (manga.cover) { %>
                        <% const catalogCoverBaseUrl = cacheBust(manga.cover, manga.coverUpdatedAt); %>
                        <% const catalogCover156 = appendCoverVariant(catalogCoverBaseUrl, 156, 208, 95); %>
                        <% const catalogCover196 = appendCoverVariant(catalogCoverBaseUrl, 196, 262, 95); %>
                        <% const catalogCover246 = appendCoverVariant(catalogCoverBaseUrl, 246, 328, 95); %>
                        <% const catalogCover312 = appendCoverVariant(catalogCoverBaseUrl, 312, 416, 95); %>
                        <% const catalogCover392 = appendCoverVariant(catalogCoverBaseUrl, 392, 523, 95); %>
                        <% const catalogCover492 = appendCoverVariant(catalogCoverBaseUrl, 492, 656, 95); %>
                        <picture>
                          <source media="(max-width: 480px)" srcset="<%= `${catalogCover156} 1x, ${catalogCover312} 2x` %>" />
                          <source media="(max-width: 1180px)" srcset="<%= `${catalogCover196} 1x, ${catalogCover392} 2x` %>" />
                          <img
                            src="<%= catalogCover246 %>"
                            srcset="<%= `${catalogCover246} 1x, ${catalogCover492} 2x` %>"
                            alt="Bìa <%= manga.title %>"
                            loading="<%= index < 2 ? "eager" : "lazy" %>"
                            decoding="async"
                            fetchpriority="<%= index === 0 ? "high" : "low" %>"
                            width="420"
                            height="600"
                          />
                        </picture>
                      <% } else { %>
                        <span class="cover__label">No Cover</span>
                      <% } %>
                    </div>
                    <div class="manga-body">
                      <% const cardTitle = truncateCardTitle(manga.title); %>
                      <h3 title="<%= manga.title %>"><%= cardTitle %></h3>
                      <p class="manga-author"><%= manga.groupName || manga.author %></p>
                      <div class="meta-row">
                        <span class="tag"><%= manga.status %></span>
                        <span class="meta"><%= manga.latestChapterIsOneshot ? "Oneshot" : `Chương ${manga.latestChapterNumber || 0}` %></span>
                      </div>
                      <% const displayGenres = (manga.genres || []).slice(0, 3); %>
                      <% const hasMoreGenres = (manga.genres || []).length > 3; %>
                      <div class="chips chips--manga-genres">
                        <% displayGenres.forEach((genre) => { %>
                          <span class="chip"><%= genre %></span>
                        <% }) %>
                        <% if (hasMoreGenres) { %>
                          <span class="chip" title="Xem chi tiết để xem đầy đủ thể loại" aria-label="Còn thêm thể loại">...</span>
                        <% } %>
                      </div>
                    </div>
                  </a>
                </article>
              <% }) %>
            </div>

            <% if (pageState.totalPages > 1) { %>
              <nav class="comment-pagination" aria-label="Phân trang truyện">
                <a
                  class="button button--ghost comment-pagination__nav <%= pageState.hasPrev ? "" : "is-disabled" %>"
                  href="<%= pageState.hasPrev ? buildCatalogPageHref(pageState.prevPage) : "#" %>"
                  aria-label="Trang trước"
                  <%= pageState.hasPrev ? "" : 'tabindex="-1" aria-disabled="true"' %>
                >
                  <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <path d="M15 18l-6-6 6-6" />
                  </svg>
                  <span class="sr-only">Trang trước</span>
                </a>
                <span class="chip comment-pagination__meta">Trang <%= pageState.page %>/<%= pageState.totalPages %></span>
                <a
                  class="button button--ghost comment-pagination__nav <%= pageState.hasNext ? "" : "is-disabled" %>"
                  href="<%= pageState.hasNext ? buildCatalogPageHref(pageState.nextPage) : "#" %>"
                  aria-label="Trang sau"
                  <%= pageState.hasNext ? "" : 'tabindex="-1" aria-disabled="true"' %>
                >
                  <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <path d="M9 18l6-6-6-6" />
                  </svg>
                  <span class="sr-only">Trang sau</span>
                </a>
              </nav>
            <% } %>
          <% } %>
        </section>
      </main>
      <%- include("partials/footer") %>
    </div>
  </body>
</html>
