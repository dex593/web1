<%
  const truncateCardTitle = (value) => {
    const text = (value || "").toString().replace(/\s+/g, " ").trim();
    if (!text) return "";

    const maxWords = 4;
    const maxChars = 24;
    const words = text.split(" ").filter(Boolean);
    let shortened = words.length > maxWords ? words.slice(0, maxWords).join(" ") : text;
    if (shortened.length > maxChars) {
      shortened = shortened.slice(0, maxChars).trimEnd();
    }

    return shortened.length < text.length ? `${shortened}...` : shortened;
  };

  const appendCoverVariant = (url, width, height, quality) => {
    const raw = (url || "").toString().trim();
    const parsedWidth = Number(width);
    const parsedHeight = Number(height);
    const parsedQuality = Number(quality);
    if (!raw || !Number.isFinite(parsedWidth) || parsedWidth <= 0) return raw;

    const params = [`w=${Math.floor(parsedWidth)}`];
    if (Number.isFinite(parsedHeight) && parsedHeight > 0) {
      params.push(`h=${Math.floor(parsedHeight)}`);
    }
    if (Number.isFinite(parsedQuality) && parsedQuality > 0) {
      params.push(`q=${Math.floor(parsedQuality)}`);
    }

    const separator = raw.includes("?") ? "&" : "?";
    return `${raw}${separator}${params.join("&")}`;
  };

  const COVER_HEIGHT_RATIO = 4 / 3;
  const COVER_HEADROOM_PX = 2;

  const buildSafeCoverSources = (baseUrl, options = {}) => {
    const slotWidths = Array.isArray(options.slotWidths) ? options.slotWidths : [];
    const dprLevels = Array.isArray(options.dprLevels) && options.dprLevels.length ? options.dprLevels : [1, 2];
    const quality = Number.isFinite(Number(options.quality)) ? Number(options.quality) : 95;
    const maxWidth = Number.isFinite(Number(options.maxWidth)) ? Number(options.maxWidth) : 1200;
    const defaultWidthOption = Number(options.defaultWidth);
    const candidates = new Set();

    slotWidths.forEach((slotWidth) => {
      const parsedSlotWidth = Number(slotWidth);
      if (!Number.isFinite(parsedSlotWidth) || parsedSlotWidth <= 0) return;

      dprLevels.forEach((density) => {
        const parsedDensity = Number(density);
        if (!Number.isFinite(parsedDensity) || parsedDensity <= 0) return;
        const safeWidth = Math.ceil(parsedSlotWidth * parsedDensity) + COVER_HEADROOM_PX;
        const clampedWidth = Math.min(Math.max(safeWidth, 120), maxWidth);
        candidates.add(clampedWidth);
      });
    });

    const widths = [...candidates].sort((a, b) => a - b);
    if (!widths.length) {
      return {
        src: baseUrl,
        srcset: ""
      };
    }

    const srcset = widths
      .map((width) => {
        const height = Math.ceil(width * COVER_HEIGHT_RATIO);
        return `${appendCoverVariant(baseUrl, width, height, quality)} ${width}w`;
      })
      .join(", ");

    const defaultWidth = Number.isFinite(defaultWidthOption) && defaultWidthOption > 0
      ? widths.find((width) => width >= defaultWidthOption) || widths[widths.length - 1]
      : widths[0];
    const defaultHeight = Math.ceil(defaultWidth * COVER_HEIGHT_RATIO);

    return {
      src: appendCoverVariant(baseUrl, defaultWidth, defaultHeight, quality),
      srcset
    };
  };

  const firstFeatured = Array.isArray(featured) && featured.length > 0 ? featured[0] : null;
  const firstFeaturedCoverBaseUrl = firstFeatured && firstFeatured.cover
    ? cacheBust(firstFeatured.cover, firstFeatured.coverUpdatedAt)
    : "";
  const firstFeaturedCoverSources = firstFeaturedCoverBaseUrl
    ? buildSafeCoverSources(firstFeaturedCoverBaseUrl, {
      slotWidths: [358],
      dprLevels: [1],
      quality: 95,
      maxWidth: 960,
      defaultWidth: 360
    })
    : { src: "", srcset: "" };
  const firstFeaturedCover = firstFeaturedCoverSources.src;
  const homepageHeadPreloadImages = firstFeaturedCover ? [firstFeaturedCover] : [];
%>
<!DOCTYPE html>
<html lang="vi">
  <%- include("partials/head", {
    title,
    headStyles: {
      fontAwesome: false
    },
    headPreloadImages: homepageHeadPreloadImages
  }) %>
  <body>
    <div class="site">
      <%- include("partials/header") %>
      <main>
        <section class="intro container">
          <div class="intro-header reveal" style="--delay: 0.1s;">
            <div class="intro-copy">
              <p class="kicker">BFANG Team Manga</p>
              <h1>Chào mừng bạn đến với website của BFANG Team.</h1>
              <p class="lede">
                BFANG Team là nhóm dịch manga hoạt động từ năm 2019 với hàng chục đầu truyện và hàng trăm chương truyện.
              </p>
            </div>
            <div class="intro-actions">
              <a class="button button--ghost" href="#featured">Tựa nổi bật</a>
            </div>
          </div>
          <div class="intro-grid">
            <div class="panel intro-card intro-card--overview reveal" style="--delay: 0.15s;">
              <p class="intro-label">Tổng quan</p>
              <div class="stat-grid">
                <div>
                  <span class="stat-value"><%= stats.totalSeries %></span>
                  <span class="stat-label">Truyện</span>
                </div>
                <div>
                  <span class="stat-value"><%= stats.totalChapters %></span>
                  <span class="stat-label">Chương</span>
                </div>
              </div>
            </div>
            <div class="panel intro-card reveal" style="--delay: 0.2s;">
              <p class="intro-label">Thông báo</p>
              <% if (homepage && homepage.notices && homepage.notices.length) { %>
                <div class="intro-notes">
                  <% homepage.notices.forEach((notice) => { %>
                    <div class="intro-note">
                      <% if (notice.title) { %>
                        <span class="intro-note-title"><%= notice.title %></span>
                      <% } %>
                      <% if (notice.body) { %>
                        <p class="intro-text"><%= notice.body %></p>
                      <% } %>
                    </div>
                  <% }) %>
                </div>
              <% } else { %>
                <p class="intro-text">Chưa có thông báo.</p>
              <% } %>
              <div class="intro-meta">
                <span class="tag">BFANG</span>
                <span class="meta">Theo dõi cập nhật mới nhất</span>
              </div>
            </div>
          </div>
        </section>

        <section id="featured" class="section container">
          <div class="section-header">
            <h2>Tựa nổi bật</h2>
            <span class="section-line"></span>
          </div>
          <div class="manga-grid manga-grid--home">
            <% featured.forEach((manga, index) => { %>
              <article class="manga-card">
                <a href="/manga/<%= manga.slug %>">
                  <div class="cover">
                    <% if (manga.cover) { %>
                      <% const featuredCoverBaseUrl = cacheBust(manga.cover, manga.coverUpdatedAt); %>
                      <% const featuredCoverSources = buildSafeCoverSources(featuredCoverBaseUrl, {
                        slotWidths: [172, 264, 358],
                        quality: 95,
                        maxWidth: 960,
                        defaultWidth: 360
                      }); %>
                      <img
                        src="<%= featuredCoverSources.src %>"
                        srcset="<%= featuredCoverSources.srcset %>"
                        sizes="(max-width: 760px) 47vw, (max-width: 1200px) 31vw, 358px"
                        alt="Bìa <%= manga.title %>"
                        loading="<%= index === 0 ? "eager" : "lazy" %>"
                        decoding="async"
                        fetchpriority="<%= index === 0 ? "high" : "low" %>"
                        width="420"
                        height="600"
                      />
                    <% } else { %>
                      <span class="cover__label">No Cover</span>
                    <% } %>
                  </div>
                  <div class="manga-body">
                    <% const featuredCardTitle = truncateCardTitle(manga.title); %>
                    <h3 title="<%= manga.title %>"><%= featuredCardTitle %></h3>
                    <p class="manga-author"><%= manga.groupName || manga.author %></p>
                    <% const displayGenres = (manga.genres || []).slice(0, 3); %>
                    <% const hasMoreGenres = (manga.genres || []).length > 3; %>
                    <div class="chips chips--manga-genres">
                      <% displayGenres.forEach((genre) => { %>
                        <span class="chip"><%= genre %></span>
                      <% }) %>
                      <% if (hasMoreGenres) { %>
                        <span class="chip" title="Xem chi tiết để xem đầy đủ thể loại" aria-label="Còn thêm thể loại">...</span>
                      <% } %>
                    </div>
                  </div>
                </a>
              </article>
            <% }) %>
          </div>
        </section>

        <% const randomSlicePool = Array.isArray(randomPageSlices) ? randomPageSlices : []; %>
        <% const randomSlicePattern = [
          { className: "first-block", size: 3 },
          { className: "block5", size: 5 },
          { className: "block2", size: 2 },
          { className: "block3", size: 3 },
          { className: "block5", size: 5 },
          { className: "block2", size: 2 }
        ]; %>
        <% const randomSliceBlocks = []; %>
        <% let randomSliceCursor = 0; %>
        <% let randomSlicePatternIndex = 0; %>
        <% while (randomSliceCursor < randomSlicePool.length) { %>
          <% const patternItem = randomSlicePattern[randomSlicePatternIndex % randomSlicePattern.length]; %>
          <% if (randomSliceCursor + patternItem.size > randomSlicePool.length) { break; } %>
          <% randomSliceBlocks.push({
            className: patternItem.className,
            items: randomSlicePool.slice(randomSliceCursor, randomSliceCursor + patternItem.size)
          }); %>
          <% randomSliceCursor += patternItem.size; %>
          <% randomSlicePatternIndex += 1; %>
        <% } %>
        <% if (randomSliceBlocks.length > 0) { %>
          <section class="section container">
            <div class="section-header section-header--panel-strip">
              <h2>Chương truyện ngẫu nhiên</h2>
              <span class="section-line"></span>
            </div>
            <div class="panel panel-strip-panel reveal" style="--delay: 0.24s;">
              <div class="koma-stream-ranking-list" role="list" aria-label="Trang truyện ngẫu nhiên">
                <% randomSliceBlocks.forEach((block, blockIndex) => { %>
                  <ul class="koma-stream-ranking-list-block <%= block.className %>" role="listitem" aria-label="Cụm lát cắt truyện">
                    <% block.items.forEach((slice) => { %>
                      <li>
                        <a
                          href="<%= slice.href %>"
                          data-bg="<%= slice.imageUrl %>"
                          title="<%= `${slice.mangaTitle} • Chương ${slice.chapterNumber} • Trang ${slice.pageNumber}` %>"
                        >
                          <span class="panel-slice__meta">CH <%= slice.chapterNumber %> · TR <%= slice.pageNumber %></span>
                        </a>
                      </li>
                    <% }) %>
                  </ul>
                <% }) %>
              </div>
            </div>
          </section>
        <% } %>

        <section class="section container">
          <div class="section-header">
            <h2>Mới cập nhật</h2>
            <span class="section-line"></span>
          </div>
          <div class="manga-grid manga-grid--home">
            <% latest.forEach((manga, index) => { %>
              <article class="manga-card">
                <a href="/manga/<%= manga.slug %>">
                  <div class="cover">
                    <% if (manga.cover) { %>
                      <% const latestCoverBaseUrl = cacheBust(manga.cover, manga.coverUpdatedAt); %>
                      <% const latestCoverSources = buildSafeCoverSources(latestCoverBaseUrl, {
                        slotWidths: [172, 262, 358],
                        quality: 95,
                        maxWidth: 900,
                        defaultWidth: 264
                      }); %>
                      <img
                        src="<%= latestCoverSources.src %>"
                        srcset="<%= latestCoverSources.srcset %>"
                        sizes="(max-width: 760px) 47vw, (max-width: 1200px) 23vw, 263px"
                        alt="Bìa <%= manga.title %>"
                        loading="lazy"
                        decoding="async"
                        fetchpriority="low"
                        width="420"
                        height="600"
                      />
                    <% } else { %>
                      <span class="cover__label">No Cover</span>
                    <% } %>
                  </div>
                  <div class="manga-body">
                    <% const latestCardTitle = truncateCardTitle(manga.title); %>
                    <h3 title="<%= manga.title %>"><%= latestCardTitle %></h3>
                    <p class="manga-update">Cập nhật <%= formatDate(manga.updatedAt) %></p>
                    <div class="meta-row">
                      <span class="tag"><%= manga.status %></span>
                      <span class="meta"><%= manga.latestChapterIsOneshot ? "Oneshot" : `Chương ${manga.latestChapterNumber || 0}` %></span>
                    </div>
                  </div>
                </a>
              </article>
            <% }) %>
          </div>
        </section>

        <section id="about" class="section container">
          <div class="panel about-panel reveal" style="--delay: 0.15s;">
            <div class="about-head">
              <p class="about-kicker">Về BFANG Team</p>
            </div>

            <div class="about-metrics" role="list" aria-label="Chỉ số hoạt động của BFANG Team">
              <div class="about-metric" role="listitem">
                <span class="about-metric__value">2019</span>
                <span class="about-metric__label">Năm thành lập</span>
              </div>
              <div class="about-metric" role="listitem">
                <span class="about-metric__value"><%= stats.totalSeries %>+</span>
                <span class="about-metric__label">Dự án manga</span>
              </div>
              <div class="about-metric" role="listitem">
                <span class="about-metric__value"><%= stats.totalChapters %>+</span>
                <span class="about-metric__label">Chương đã dịch</span>
              </div>
            </div>

            <div class="about-grid">
              <article class="about-card">
                <h3>Tiêu chuẩn nội dung</h3>
                <p>
                  Chúng tôi chỉ làm manga, và thể loại yêu thích nhất là Drama.
                </p>
                <p>
                  Các dự án được dịch thuật từ tiếng Anh hoặc tiếng Nhật và sử dụng Adobe Photoshop để biên tập.
                </p>
              </article>

              <article class="about-card">
                <h3>Kênh liên hệ</h3>
                <div class="about-contact-list">
                  <a class="about-contact-link" href="https://facebook.com/Bfangteam/" target="_blank" rel="noopener noreferrer">
                    <span class="about-contact-link__icon" aria-hidden="true">
                      <svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor">
                        <path d="M14 8h3V4h-3c-3.3 0-5 1.7-5 5v3H6v4h3v4h4v-4h3l1-4h-4V9c0-.7.3-1 1-1z" />
                      </svg>
                    </span>
                    <span class="about-contact-link__body">
                      <span class="about-contact-link__label">Facebook</span>
                      <span class="about-contact-link__value">facebook.com/Bfangteam</span>
                    </span>
                    <svg class="about-contact-link__arrow" viewBox="0 0 24 24" width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                      <path d="M7 17L17 7" />
                      <path d="M9 7h8v8" />
                    </svg>
                  </a>

                  <a class="about-contact-link" href="https://discord.moetruyen.net/" target="_blank" rel="noopener noreferrer">
                    <span class="about-contact-link__icon" aria-hidden="true">
                      <svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor">
                        <path d="M18.5 6.6A13.6 13.6 0 0 0 15 5.5l-.4.7c1.5.4 2.2.9 3 1.5-2.2-1-4.5-1-6.6-1s-4.4 0-6.6 1c.8-.6 1.5-1.1 3-1.5L7 5.5a13.6 13.6 0 0 0-3.5 1.1C1.3 10 0.7 13.4 1 16.7A14 14 0 0 0 5.2 19l.9-1.4c-.7-.2-1.4-.5-2-.9l.5-.4c2 1 4.2 1.2 6.4 1.2 2.2 0 4.4-.2 6.4-1.2l.5.4c-.6.4-1.3.7-2 .9l.9 1.4a14 14 0 0 0 4.2-2.3c.4-3.7-.7-7-2.5-10.1zM8.4 14.7c-.8 0-1.4-.7-1.4-1.6s.6-1.6 1.4-1.6c.8 0 1.4.7 1.4 1.6s-.6 1.6-1.4 1.6zm7.2 0c-.8 0-1.4-.7-1.4-1.6s.6-1.6 1.4-1.6c.8 0 1.4.7 1.4 1.6s-.6 1.6-1.4 1.6z" />
                      </svg>
                    </span>
                    <span class="about-contact-link__body">
                      <span class="about-contact-link__label">Discord</span>
                      <span class="about-contact-link__value">discord.moetruyen.net</span>
                    </span>
                    <svg class="about-contact-link__arrow" viewBox="0 0 24 24" width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                      <path d="M7 17L17 7" />
                      <path d="M9 7h8v8" />
                    </svg>
                  </a>
                </div>
              </article>
            </div>
          </div>
        </section>
      </main>
      <%- include("partials/footer") %>
    </div>
  </body>
</html>
