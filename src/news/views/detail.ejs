<!DOCTYPE html>
<html lang="vi">
<%
    const newsBase = (newsBasePath || "/tin-tuc").toString().trim().replace(/\/+$/, "") || "/tin-tuc";
    const newsAssets = (newsAssetPath || `${newsBase}/assets`).toString().trim().replace(/\/+$/, "");
    const newsSite = (siteUrl || "").toString().trim().replace(/\/+$/, "");
    const newsUrl = `${newsSite}/${newsItem.id}`;
    const fallbackImage = `${newsAssets}/images/avatar.svg`;
    const assetToken = assetVersion == null ? "" : String(assetVersion).trim();
    const assetUrl = (url) => {
        const raw = (url || "").toString();
        if (!raw) return raw;
        if (typeof cacheBust === "function") {
            return cacheBust(raw, assetToken);
        }
        if (!assetToken) return raw;
        const separator = raw.includes("?") ? "&" : "?";
        return `${raw}${separator}t=${encodeURIComponent(assetToken)}`;
    };
%>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= newsItem.noidung.substring(0, 60).trim() %>... | A-M News Việt Nam</title>

    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="referrer" content="no-referrer">

    <meta name="description" content="<%= newsItem.noidung.substring(0, 160).trim() %>...">
    <meta name="keywords" content="anime news, manga news, tin tức anime, tin tức manga, <%= newsItem.noidung.substring(0, 50).trim() %>">
    <meta name="author" content="A-M News Viet Nam">
    <meta name="robots" content="index, follow">
    <meta name="language" content="Vietnamese">
    <meta name="article:published_time" content="<%= new Date(newsItem.time).toISOString() %>">
    <meta name="article:author" content="A-M News Viet Nam">

    <meta property="og:type" content="article">
    <meta property="og:url" content="<%= newsUrl %>">
    <meta property="og:title" content="<%= newsItem.noidung.substring(0, 60).trim() %>...">
    <meta property="og:description" content="<%= newsItem.noidung.substring(0, 160).trim() %>...">
    <% if (newsItem.image) { %>
    <meta property="og:image" content="<%= newsItem.image %>">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <% } else { %>
    <meta property="og:image" content="<%= fallbackImage %>">
    <% } %>
    <meta property="og:site_name" content="A-M News Viet Nam">
    <meta property="og:locale" content="vi_VN">
    <meta property="article:published_time" content="<%= new Date(newsItem.time).toISOString() %>">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="<%= newsUrl %>">
    <meta name="twitter:title" content="<%= newsItem.noidung.substring(0, 60).trim() %>...">
    <meta name="twitter:description" content="<%= newsItem.noidung.substring(0, 160).trim() %>...">
    <% if (newsItem.image) { %>
    <meta name="twitter:image" content="<%= newsItem.image %>">
    <% } else { %>
    <meta name="twitter:image" content="<%= fallbackImage %>">
    <% } %>

    <link rel="canonical" href="<%= newsUrl %>">

    <link rel="icon" type="image/svg+xml" href="/logobfang.svg">
    <link rel="apple-touch-icon" href="/logobfang.svg">
    <link rel="manifest" href="<%= `${newsAssets}/manifest.json` %>">
    <meta name="theme-color" content="#0c0c0c">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdn.jsdelivr.net">

    <script type="application/ld+json" nonce="<%= cspNonce || '' %>">
    {
      "@context": "https://schema.org",
      "@type": "NewsArticle",
      "headline": "<%= newsItem.noidung.substring(0, 110).trim().replace(/"/g, '\\"') %>",
      "description": "<%= newsItem.noidung.substring(0, 160).trim().replace(/"/g, '\\"') %>",
      "image": <%= newsItem.image ? '"' + newsItem.image + '"' : '"' + fallbackImage + '"' %>,
      "datePublished": "<%= new Date(newsItem.time).toISOString() %>",
      "dateModified": "<%= new Date(newsItem.time).toISOString() %>",
      "author": {
        "@type": "Organization",
        "name": "A-M News Viet Nam",
        "url": "<%= `${newsSite}/` %>"
      },
      "publisher": {
        "@type": "Organization",
        "name": "A-M News Viet Nam",
        "logo": {
          "@type": "ImageObject",
          "url": "<%= fallbackImage %>"
        }
      },
      "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "<%= newsUrl %>"
      }
    }
    </script>

    <script type="application/ld+json" nonce="<%= cspNonce || '' %>">
    {
      "@context": "https://schema.org",
      "@type": "BreadcrumbList",
      "itemListElement": [
        {
          "@type": "ListItem",
          "position": 1,
          "name": "Trang chủ",
          "item": "<%= `${newsSite}/` %>"
        },
        {
          "@type": "ListItem",
          "position": 2,
          "name": "Tin tức",
          "item": "<%= newsUrl %>"
        }
      ]
    }
    </script>

    <link rel="stylesheet" href="<%= assetUrl('/styles.css') %>">
    <link rel="stylesheet" href="<%= assetUrl(`${newsAssets}/css/style.css`) %>">
    <link rel="stylesheet" href="<%= assetUrl(`${newsAssets}/css/video-player.css`) %>">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.2/css/all.min.css">
</head>
<body data-news-base-path="<%= newsBase %>">
    <%- include("../../../views/partials/header") %>

    <main class="main">
        <div class="container">
            <div class="detail-wrapper">
                <div class="detail-content">
                    <a href="<%= newsBase %>" class="back-btn">
                        <i class="fas fa-arrow-left"></i>
                        Quay lại
                    </a>

                    <article class="detail-card">
                        <div class="news-card-header">
                            <div class="news-source">
                                <img src="<%= `${newsAssets}/images/avatar.svg` %>" alt="Avatar" class="avatar" onerror="this.src='<%= `${newsAssets}/images/avatar-placeholder.svg` %>'">
                                <div class="source-info">
                                    <h3>A-M News Viet Nam</h3>
                                    <span class="time"><%= formatNewsDate(newsItem.time) %></span>
                                </div>
                            </div>
                            <%
                                const itemHashtags = extractHashtags(newsItem.noidung);
                                const itemCategory = getCategoryFromHashtags(itemHashtags);
                                const itemCategoryInfo = getCategoryInfo(itemCategory);
                            %>
                            <% if (itemCategory !== 'other') { %>
                                <span class="category-badge category-<%= itemCategory %>">
                                    <i class="<%= itemCategoryInfo.icon %>"></i>
                                    <%= itemCategoryInfo.name %>
                                </span>
                            <% } %>
                        </div>

                        <div class="detail-body">
                            <div class="news-content-detail"><%- convertHashtagsToLinks(newsItem.noidung.trim(), newsBase) %></div>

                            <% if (newsItem.video) { %>
                                <div class="media-container">
                                    <div class="custom-video-player">
                                        <% if (newsItem.image) { %>
                                            <img src="<%= newsItem.image %>" alt="Video thumbnail" class="video-poster">
                                        <% } %>
                                        <div class="video-play-overlay">
                                            <i class="fas fa-play"></i>
                                        </div>
                                        <div class="video-loading"></div>
                                        <video preload="metadata" playsinline referrerpolicy="no-referrer">
                                            <source src="<%= newsItem.video %>" type="video/mp4">
                                            Trình duyệt không hỗ trợ video.
                                        </video>
                                        <div class="video-controls">
                                            <div class="video-progress-container">
                                                <div class="video-progress"></div>
                                            </div>
                                            <div class="video-bottom-controls">
                                                <div class="video-left-controls">
                                                    <button class="video-btn video-play-btn">
                                                        <i class="fas fa-play"></i>
                                                    </button>
                                                    <span class="video-time">0:00 / 0:00</span>
                                                </div>
                                                <div class="video-right-controls">
                                                    <div class="video-volume-container">
                                                        <button class="video-btn video-volume-btn">
                                                            <i class="fas fa-volume-up"></i>
                                                        </button>
                                                        <div class="video-volume-slider">
                                                            <div class="video-volume-level"></div>
                                                        </div>
                                                    </div>
                                                    <button class="video-btn video-fullscreen-btn">
                                                        <i class="fas fa-expand"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="video-error-message">
                                            <span class="video-error-text">Khong tai duoc video.</span>
                                            <a class="video-error-link" href="<%= newsItem.video %>" target="_blank" rel="noopener noreferrer">Mo video truc tiep</a>
                                        </div>
                                    </div>
                                </div>
                            <% } else if (newsItem.image) { %>
                                <div class="media-container">
                                    <img src="<%= newsItem.image %>" alt="News image" class="news-image">
                                </div>
                            <% } %>
                        </div>

                        <div class="detail-footer">
                            <div class="action-buttons">
                                <button class="action-btn share-btn" data-url="<%= newsUrl %>">
                                    <i class="fas fa-share"></i>
                                    <span>Chia sẻ</span>
                                </button>
                                <button class="action-btn copy-btn" data-url="<%= newsUrl %>">
                                    <i class="fas fa-copy"></i>
                                    <span>Copy link</span>
                                </button>
                            </div>
                        </div>
                    </article>
                </div>

                <aside class="detail-sidebar">
                    <div class="sidebar-card">
                        <h3 class="sidebar-title">
                            <i class="fas fa-history"></i>
                            Tin đã xem
                        </h3>
                        <div id="viewed-news" class="viewed-news">
                            <p class="no-viewed">Chưa có tin nào được xem</p>
                        </div>
                    </div>

                    <div class="sidebar-card social-links">
                        <h3 class="sidebar-title">
                            <i class="fas fa-share-alt"></i>
                            Theo dõi chúng tôi
                        </h3>
                        <div class="social-buttons">
                            <a href="https://www.facebook.com/MangaNewsVN/" target="_blank" class="social-btn facebook">
                                <i class="fab fa-facebook"></i>
                                Facebook Page
                            </a>
                            <a href="https://discord.gg/dongmoe" target="_blank" class="social-btn discord">
                                <i class="fab fa-discord"></i>
                                Discord Server
                            </a>
                        </div>
                    </div>
                </aside>
            </div>
        </div>
    </main>

    <%- include("../../../views/partials/footer") %>

    <div id="toast" class="toast"></div>

    <script nonce="<%= cspNonce || '' %>">
        window.__AUTH = <%- JSON.stringify(authPublicConfig || {}) %>;
        if (window.__AUTH && typeof window.__AUTH === "object") {
            window.__AUTH.notificationsScriptUrl = "/notifications.js";
        }
    </script>
    <script src="<%= assetUrl('/confirm.js') %>"></script>
    <script src="<%= assetUrl('/auth.js') %>"></script>
    <script src="<%= assetUrl('/messages-indicator.js') %>"></script>
    <script src="<%= assetUrl(`${newsAssets}/js/video-player.js`) %>"></script>
    <script src="<%= assetUrl(`${newsAssets}/js/main.js`) %>"></script>
</body>
</html>
